using System.Net.Http;
using System.Threading.Tasks;

namespace AnaliseMalware.Services
{
    public class VirusTotalService
    {
        private readonly HttpClient _httpClient;
        private readonly string _apiKey;

        public VirusTotalService(HttpClient httpClient, string apiKey)
        {
            _httpClient = httpClient;
            _apiKey = apiKey;
        }

        public async Task<string> ScanFileAsync(byte[] fileContent, string fileName)
        {
            using var httpClient = new HttpClient();
            httpClient.DefaultRequestHeaders.Add("x-apikey", "3935c5a58f2906853a70721c39dff87ecb01fa464bac07ca33ca5b0ef5a06c6c");

            var request = new HttpRequestMessage(HttpMethod.Post, "https://www.virustotal.com/api/v3/files");
            request.Headers.Add("x-apikey", _apiKey);

            var content = new MultipartFormDataContent
        {
            { new ByteArrayContent(fileContent), "file", fileName }
        };

            request.Content = content;

            var response = await _httpClient.SendAsync(request);
            response.EnsureSuccessStatusCode();

            return await response.Content.ReadAsStringAsync();
        }
    }
}
