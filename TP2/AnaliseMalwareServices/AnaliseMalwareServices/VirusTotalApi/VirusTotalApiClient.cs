using RestSharp;
using VirusTotalNet;
using VirusTotalNet.Results;

namespace AnaliseMalwareServices.VirusTotalApi
{
    /// <summary>  
    /// Client for interacting with the VirusTotal API.  
    /// </summary>  
    public class VirusTotalApiClient
    {
        private readonly string _apiKey;
        private readonly RestClient _client;

        public VirusTotalApiClient(string apiKey)
        {
            _apiKey = apiKey;
            var options = new RestClientOptions("https://www.virustotal.com/api/v3");
            _client = new RestClient(options);
        }

        // Upload a file to VirusTotal for scanning
        public async Task<string> UploadFileAsync(byte[] fileData, string fileName)
        {
            // Create a temporary file path
            var tempFilePath = Path.Combine(Path.GetTempPath(), fileName);

            // Write the byte[] to a temporary file
            await File.WriteAllBytesAsync(tempFilePath, fileData);

            var request = new RestRequest("files", Method.Post);
            request.AddHeader("x-apikey", _apiKey);

            // Use AddFile with the file path
            request.AddFile("file", tempFilePath);

            var response = await _client.ExecuteAsync(request);

            // Optionally, delete the temporary file after upload
            File.Delete(tempFilePath);

            return response.Content;
        }


        public async Task<string> GetFullReportAsync(string analysisId)
        {
            var request = new RestRequest($"analyses/{analysisId}", Method.Get);
            request.AddHeader("x-apikey", _apiKey);

            var response = await _client.ExecuteAsync(request);
            return response.Content; // This will contain the full analysis report for the file
        }

    }
}
